#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if backend files changed
BACKEND_CHANGED=$(echo "$STAGED_FILES" | grep -E "^backend/" || true)

# Check if frontend/extension files changed
FRONTEND_CHANGED=$(echo "$STAGED_FILES" | grep -E "^(extension/|shared/)" || true)

# Track if any tests failed
TESTS_FAILED=0

# Run backend tests if backend files changed
if [ -n "$BACKEND_CHANGED" ]; then
  echo ""
  echo "ğŸ“¦ Backend changes detected:"
  echo "$BACKEND_CHANGED"
  echo ""
  echo "ğŸ Running backend tests (pytest)..."
  cd backend
  python -m pytest test_backend.py -v --tb=short
  if [ $? -ne 0 ]; then
    echo "âŒ Backend tests failed"
    TESTS_FAILED=1
  else
    echo "âœ… Backend tests passed"
  fi
  cd ..
else
  echo "â­ï¸  No backend changes - skipping backend tests"
fi

# Run frontend tests if frontend files changed
if [ -n "$FRONTEND_CHANGED" ]; then
  echo ""
  echo "ğŸ“¦ Frontend changes detected:"
  echo "$FRONTEND_CHANGED"
  echo ""
  echo "ğŸ§ª Running frontend tests (vitest)..."
  cd extension

  # Type check first
  echo "ğŸ“ Type checking..."
  npm run type-check
  if [ $? -ne 0 ]; then
    echo "âŒ TypeScript type check failed"
    TESTS_FAILED=1
  else
    echo "âœ… Type check passed"

    # Run tests
    npm run test:run
    if [ $? -ne 0 ]; then
      echo "âŒ Frontend tests failed"
      TESTS_FAILED=1
    else
      echo "âœ… Frontend tests passed"
    fi
  fi
  cd ..
else
  echo "â­ï¸  No frontend changes - skipping frontend tests"
fi

# Summary
echo ""
echo "=========================================="
if [ $TESTS_FAILED -eq 0 ]; then
  echo "âœ… All pre-commit checks passed!"
  exit 0
else
  echo "âŒ Some checks failed - commit aborted"
  exit 1
fi
